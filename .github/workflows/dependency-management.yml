name: Dependency Management

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Check for dependency updates
  dependency-check:
    name: ğŸ“¦ Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Check for Updates
        run: |
          echo "ğŸ” Checking for outdated packages..."
          npm outdated || true
          
          echo "ğŸ“‹ Current dependency versions:"
          npm list --depth=0

      - name: ğŸ›¡ï¸ Security Audit
        run: |
          echo "ğŸ›¡ï¸ Running security audit..."
          npm audit --audit-level=moderate || true

      - name: ğŸ“Š Generate Dependency Report
        run: |
          echo "# Dependency Report" > dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "## Outdated Packages" >> dependency-report.md
          npm outdated --parseable | while read line; do
            if [[ -n "$line" ]]; then
              echo "- $line" >> dependency-report.md
            fi
          done || true
          
          echo "" >> dependency-report.md
          echo "## Security Audit" >> dependency-report.md
          npm audit --audit-level=low || echo "No security issues found" >> dependency-report.md

      - name: ğŸ’¾ Upload Report
        uses: actions/upload-artifact@v3
        with:
          name: dependency-report
          path: dependency-report.md

  # Auto-update minor and patch versions
  auto-update:
    name: ğŸ”„ Auto Update
    runs-on: ubuntu-latest
    needs: dependency-check
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”„ Update Dependencies
        run: |
          echo "ğŸ”„ Updating patch and minor versions..."
          npm update
          
          echo "ğŸ“‹ Changes made:"
          git diff package-lock.json || echo "No changes to package-lock.json"

      - name: ğŸ§ª Test After Updates
        run: |
          echo "ğŸ§ª Running tests after updates..."
          npm run test
          
          echo "ğŸ—ï¸ Testing build after updates..."
          npm run build

      - name: ğŸ“ Create PR for Updates
        if: success()
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ“ Creating PR for dependency updates..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            branch_name="deps/auto-update-$(date +%Y%m%d)"
            git checkout -b "$branch_name"
            git add package-lock.json
            git commit -m "chore: Auto-update dependencies

            - Updated patch and minor versions
            - All tests passing
            - Build successful
            
            Generated by GitHub Actions"
            
            echo "ğŸš€ Branch created: $branch_name"
            echo "You can manually create a PR from this branch"
          else
            echo "âœ… No dependency updates available"
          fi
