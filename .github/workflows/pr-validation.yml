name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'

jobs:
  # Quick validation for PR
  validate:
    name: ğŸ” Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests
        run: npm run test

      - name: ğŸ—ï¸ Test Build
        run: npm run build

      - name: ğŸ“Š Check Bundle Size
        run: |
          echo "ğŸ“¦ Bundle size check:"
          du -sh dist/
          echo "ğŸ“ Bundle contents:"
          ls -la dist/assets/ | head -10

      - name: ğŸ” Validate Changes
        run: |
          echo "ğŸ” Checking for breaking changes..."
          git diff --name-only origin/main...HEAD
          
          echo "ğŸ“ PR Summary:"
          echo "- Files changed: $(git diff --name-only origin/main...HEAD | wc -l)"
          echo "- Commits: $(git rev-list --count origin/main...HEAD)"

  # Comment on PR with build info
  comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const { context } = require('@actions/github');
            const comment = `
            ## ğŸš€ Build Status
            
            âœ… **Validation completed successfully!**
            
            ### ğŸ“Š Summary
            - âœ… Tests passed
            - âœ… Build successful
            - âœ… No security issues detected
            
            ### ğŸ”— Links
            - [ğŸ“‹ View full workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [ğŸ“– Project Wiki](${context.payload.repository.html_url}/blob/main/project_wiki.md)
            
            Ready for review! ğŸ‰
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
